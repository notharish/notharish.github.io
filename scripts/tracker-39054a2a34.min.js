window.CONFIG={CLIENT_ID:"209191307792-57cp00mia6fgfc7dj0ohbbgqqtfu45q4.apps.googleusercontent.com",SHEET_ID:"1t73pb_DWXW5hBySNJeIjrkve72pVTae1iaYCj-MMBog",SCOPES:"https://www.googleapis.com/auth/spreadsheets"},(()=>{let t="tracker_oauth_tokens",n=3e5,a={accessToken:null,gapiLoaded:!1,tokenClient:null};function r(){return new Promise(function(e,t){a.gapiLoaded&&window.gapi&&window.gapi.client?e():window.gapi&&window.gapi.load?window.gapi.load("client",function(){window.gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]}).then(function(){a.gapiLoaded=!0,e()}).catch(t)}):t(new Error("gapi not loaded"))})}function o(){try{var e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(e){return console.error("Error reading stored tokens:",e),null}}function i(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){console.error("Error storing tokens:",e)}}function s(){try{localStorage.removeItem(t)}catch(e){console.error("Error clearing tokens:",e)}}function l(e){return e&&e.access_token&&e.expires_at&&Date.now()<e.expires_at-n}function c(){return new Promise(function(t,n){let r=o();var e;r&&r.refresh_token?window.CONFIG&&window.CONFIG.CLIENT_ID?((e=new URLSearchParams).append("client_id",window.CONFIG.CLIENT_ID),e.append("refresh_token",r.refresh_token),e.append("grant_type","refresh_token"),fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(function(e){return e.json()}).then(function(e){e.error?n(new Error("Token refresh failed: "+e.error)):(i(e={access_token:e.access_token,refresh_token:r.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:r.scope,token_type:r.token_type||"Bearer"}),a.accessToken=e.access_token,t(e))}).catch(n)):n(new Error("Client ID not configured")):n(new Error("No refresh token available"))})}function e(){return new Promise(function(n,r){try{var e=(()=>{if(!a.tokenClient){if(!window.google||!window.google.accounts||!window.google.accounts.oauth2)throw new Error("Google Identity Services not available");a.tokenClient=window.google.accounts.oauth2.initTokenClient({client_id:window.CONFIG&&window.CONFIG.CLIENT_ID,scope:window.CONFIG&&window.CONFIG.SCOPES,callback:function(){}})}return a.tokenClient})();e.callback=function(e){var t;e&&e.access_token?(i(t={access_token:e.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:e.scope,token_type:e.token_type||"Bearer"}),a.accessToken=e.access_token,n(t)):r(new Error("No access token"))},e.requestAccessToken({prompt:""})}catch(e){r(e)}})}function d(){e().then(function(e){return r().then(function(){return e})}).then(function(e){window.gapi&&window.gapi.client&&(window.gapi.client.setToken({access_token:e.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:e.access_token,tokenData:e}})))}).catch(function(e){console.error("Sign-in error:",e),s(),document.dispatchEvent(new CustomEvent("tracker:auth:error",{detail:e}))})}function u(){var e=document.getElementById("googleSignInBtn");e&&e.addEventListener("click",d);let t=o();if(t&&l(t))if(a.accessToken=t.access_token,window.gapi&&window.gapi.load)r().then(function(){window.gapi&&window.gapi.client&&(window.gapi.client.setToken({access_token:t.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:t.access_token,tokenData:t}})))}).catch(function(e){console.error("Error loading with stored token:",e),s()});else{let e=function(){window.gapi&&window.gapi.load?r().then(function(){window.gapi&&window.gapi.client&&(window.gapi.client.setToken({access_token:t.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:t.access_token,tokenData:t}})))}).catch(function(e){console.error("Error loading with stored token:",e),s()}):setTimeout(e,100)};e()}}document.addEventListener("DOMContentLoaded",u),window.TrackerAuth={getToken:function(){return o()||null},clearTokens:function(){s(),a.accessToken=null,document.dispatchEvent(new CustomEvent("tracker:auth:signout"))},isAuthenticated:function(){var e=o();return!(!e||!l(e))},refreshToken:c,initAuthUI:u,onSignInClick:d,withValidToken:function(r){return new Promise(function(t,n){var e=o();e&&l(e)?(a.accessToken=e.access_token,window.gapi&&window.gapi.client?(window.gapi.client.setToken({access_token:e.access_token}),r().then(t).catch(n)):n(new Error("gapi client not available"))):e&&e.refresh_token?c().then(function(e){window.gapi&&window.gapi.client?(window.gapi.client.setToken({access_token:e.access_token}),r().then(t).catch(n)):n(new Error("gapi client not available"))}).catch(function(e){s(),n(new Error("Token refresh failed, please sign in again"))}):n(new Error("No valid token available, please sign in"))})}}})(),(()=>{let h=window.CONFIG&&window.CONFIG.SHEET_ID||"",u=["Date","Number","Text","Dropdown"],p={},t=null,w=null,f=null,g="A";function m(e){return(e||0===e)&&String(e).trim().toLowerCase().endsWith("hide")}function k(e,t,n){if(null==e||""===e)return!1;switch(t){case"Date":return!isNaN(Date.parse(e));case"Number":return!isNaN(parseFloat(e))&&isFinite(e);case"Text":return"string"==typeof e||"number"==typeof e;case"Dropdown":return!(!n||!n.includes(e));default:return!1}}function e(){return t?Promise.resolve(t):window.TrackerAuth?window.TrackerAuth.withValidToken(function(){return window.gapi&&window.gapi.client?window.gapi.client.sheets.spreadsheets.get({spreadsheetId:h,fields:"sheets(properties(sheetId,title),tables(tableId,name,range,columnProperties(columnIndex,columnName,columnType,dataValidationRule(condition(type,values(userEnteredValue))))))"}):Promise.reject(new Error("gapi client not available"))}).then(function(e){e=(f=e)&&e.result&&e.result.sheets||[];return t=e.map(function(e){return{sheetId:e.properties.sheetId,title:e.properties.title}}).filter(function(e){return!m(e.title)})}):Promise.reject(new Error("TrackerAuth not available"))}function n(){if(!w)return Promise.reject(new Error("No tab selected"));let d=w.sheetId;return p[d]?Promise.resolve(p[d]):e().then(function(){var e=f,t=e&&e.result&&e.result.sheets||[];let n=null;for(let e=0;e<t.length;e++)if(t[e]&&t[e].properties&&t[e].properties.sheetId===d){n=t[e];break}if(!n)throw new Error("Sheet not found: "+d);var e=n.properties.sheetId,r=n.tables||[];if(0===r.length)throw new Error("No tables found in sheet: "+w.title);var a=r[0].columnProperties||[];if(0===a.length)throw new Error("No column properties found in table");if("Date"!==a[0].columnName)throw new Error('First column must be "Date"');var o={},i=[];for(let e=0;e<a.length;e++){var s=a[e],l=s.columnName,c=s.columnType;if(0===e||!m(l)){i.push(l);let e="Text",t=null;c&&("DATE"===(c=String(c).toUpperCase())||"DATE_TIME"===c||"TIME_DATE"===c?e="Date":"DOUBLE"===c||"NUMBER"===c||"PERCENT"===c||"CURRENCY"===c||"SCIENTIFIC"===c?e="Number":"TEXT"===c?e="Text":"DROPDOWN"===c&&(e="Dropdown",s.dataValidationRule)&&s.dataValidationRule.condition&&"ONE_OF_LIST"===s.dataValidationRule.condition.type&&s.dataValidationRule.condition.values&&(t=s.dataValidationRule.condition.values.map(function(e){return e.userEnteredValue}))),o[l]={index:s.columnIndex,type:e,supported:u.includes(e),options:t||null}}}r={columns:o,headers:i,dateColumn:"Date",sheetId:e};return p[d]=r})}window.TrackerSheets={readLastEntry:function(){return w?n().then(function(i){let e=w.title+"!2:2";return window.TrackerAuth?window.TrackerAuth.withValidToken(function(){return window.gapi&&window.gapi.client?window.gapi.client.sheets.spreadsheets.values.get({spreadsheetId:h,range:e,majorDimension:"ROWS"}):Promise.reject(new Error("gapi client not available"))}).then(function(e){var t=e&&e.result&&e.result.values&&e.result.values[0]||null;if(!t||0===t.length||!t[0])return{date:null,data:{}};var n,r,a,o={date:t[0],data:{}};for(n in i.columns)i.columns.hasOwnProperty(n)&&void 0!==(a=t[(r=i.columns[n]).index])&&""!==a&&("Number"===r.type?o.data[n]=parseFloat(a):(r.type,o.data[n]=a));return o}):Promise.reject(new Error("TrackerAuth not available"))}):Promise.reject(new Error("No tab selected"))},appendEntry:function(u){return w?n().then(function(e){for(var t in u)if("Date"!==t){var n=e.columns[t];if(!n)throw new Error("Unknown column: "+t);if(!n.supported)throw new Error("Unsupported column type: "+t+" ("+n.type+")");if(!k(u[t],n.type,n.options))throw new Error("Invalid data for column "+t+": expected "+n.type)}let r=0;for(var a in e.columns)e.columns.hasOwnProperty(a)&&(a=e.columns[a])&&"number"==typeof a.index&&a.index>r&&(r=a.index);let o=new Array(r+1);for(let e=0;e<o.length;e++)o[e]="";var i,s,l=new Date;for(i in o[0]=[l.getFullYear(),String(l.getMonth()+1).padStart(2,"0"),String(l.getDate()).padStart(2,"0")].join("-"),u)u.hasOwnProperty(i)&&(s=e.columns[i])&&(o[s.index]=u[i]);let c={values:[o]},d=(e=>{let t=e+1,n="";for(;0<t;){var r=(t-1)%26;n=String.fromCharCode(g.charCodeAt(0)+r)+n,t=Math.floor((t-r)/26)}return n})(r);if(e.sheetId)return window.TrackerAuth?window.TrackerAuth.withValidToken(function(){return window.gapi&&window.gapi.client?window.gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:h,resource:{requests:[{insertDimension:{range:{sheetId:e.sheetId,dimension:"ROWS",startIndex:1,endIndex:2},inheritFromBefore:!1}}]}}):Promise.reject(new Error("gapi client not available"))}).then(function(){return window.TrackerAuth?window.TrackerAuth.withValidToken(function(){return window.gapi&&window.gapi.client?window.gapi.client.sheets.spreadsheets.values.update({spreadsheetId:h,range:w.title+"!A2:"+d+"2",valueInputOption:"USER_ENTERED",resource:c}):Promise.reject(new Error("gapi client not available"))}):Promise.reject(new Error("TrackerAuth not available"))}).then(function(){return{ok:!0,date:o[0],data:u}}):Promise.reject(new Error("TrackerAuth not available"));throw new Error("Sheet ID not available in column metadata.")}):Promise.reject(new Error("No tab selected"))},getColumnMetadata:n,getTabId:function(){return w?Promise.resolve(w.sheetId):Promise.reject(new Error("No tab selected"))},validateData:k,getAvailableTabs:e,setSelectedTab:function(t){return e().then(function(e){e=e.find(function(e){return e.sheetId===t});if(!e)throw new Error("Tab not found: "+t);w=e,p[t]=null})},getSelectedTab:function(){return w},clearCache:function(){p={},t=null,w=null,f=null}}})(),(()=>{let i={},s={date:null,data:{}},l=null,d={};function e(e){return document.getElementById(e)}function c(e,t){i.status.textContent=e,i.status.className="alert "+("error"===t?"alert-danger":"alert-success"),i.status.style.display="block",setTimeout(function(){i.status.style.display="none"},3e3)}function n(e){l=e,i.formContainer.innerHTML="";var t=e.headers,n=e.columns;for(let e=1;e<t.length;e++){var r=t[e],a=n[r];a&&a.supported&&(a=((e,t,n)=>{var r=document.createElement("div"),a=(r.className="form-group",document.createElement("label"));a.textContent=e,a.setAttribute("for","input_"+e),a.style.display="block",a.style.marginBottom="5px",a.style.fontWeight="500";let o;if("Dropdown"===t.type){var i=document.createElement("select"),s=(i.id="input_"+e,i.name=e,i.className="form-control",i.style.textAlign="center",document.createElement("option"));if(s.value="",s.textContent="Select "+e.toLowerCase(),i.appendChild(s),t.options&&0<t.options.length)for(let e=0;e<t.options.length;e++){var l=document.createElement("option");l.value=t.options[e],l.textContent=t.options[e],n===t.options[e]&&(l.selected=!0),i.appendChild(l)}o=i}else{var c=document.createElement("input");switch(c.id="input_"+e,c.name=e,c.className="form-control",c.style.textAlign="center",t.type){case"Date":c.type="date",c.value=n||"";break;case"Number":c.type="number",c.step="0.1",c.placeholder="e.g. 175.2",c.value=n||"";break;case"Text":c.type="text",c.placeholder="Enter "+e.toLowerCase(),c.value=n||"";break;default:c.type="text",c.value=n||""}o=c}return r.appendChild(a),r.appendChild(o),d[e]=o,r})(r,a,s.data[r]||""),i.formContainer.appendChild(a))}}function u(){s.date?i.lastDate.textContent="Last updated: "+new Date(s.date).toLocaleString():i.lastDate.textContent="No previous entries"}function r(){if(i.tabSelector){var e=parseInt(i.tabSelector.value,10);if(e){for(var t in i.formPanel&&(i.formPanel.style.display="block"),i.saveFeedbackPanel&&(i.saveFeedbackPanel.style.display="none"),i.saveFeedback&&(i.saveFeedback.innerHTML=""),i.formContainer.innerHTML="",s={date:null,data:{}},l=null,d)d.hasOwnProperty(t)&&delete d[t];window.TrackerSheets?window.TrackerSheets.setSelectedTab(e).then(function(){return Promise.all([window.TrackerSheets.getColumnMetadata(),window.TrackerSheets.readLastEntry()])}).then(function(e){var t=e[0],e=e[1],e=(s=e,n(t),u(),window.TrackerSheets.getSelectedTab());e&&c("Switched to tab: "+e.title,"success")}).catch(function(e){console.error("Failed to switch tab:",e),c("Failed to switch tab: "+e.message,"error"),e&&e.message&&(-1!==e.message.indexOf("token")||-1!==e.message.indexOf("sign in"))&&(i.auth.style.display="block",i.main.style.display="none")}):c("TrackerSheets not available","error")}}}function t(){i.auth.style.display="none",i.main.style.display="block",window.TrackerSheets?window.TrackerSheets.getAvailableTabs().then(function(t){if(i.tabSelector){i.tabSelector.innerHTML="";var e=document.createElement("option");e.value="",e.textContent="Select a tab...",i.tabSelector.appendChild(e);for(let e=0;e<t.length;e++){var n=document.createElement("option");n.value=String(t[e].sheetId),n.textContent=t[e].title,i.tabSelector.appendChild(n)}0<t.length&&(i.tabSelector.value=String(t[0].sheetId),r())}}).catch(function(e){console.error("Failed to load tabs:",e),c("Failed to load tabs: "+e.message,"error"),(e.message.includes("token")||e.message.includes("sign in"))&&(i.auth.style.display="block",i.main.style.display="none")}):c("TrackerSheets not available","error")}function a(e){console.error("Authentication error:",e.detail),c("Authentication failed: "+(e.detail&&e.detail.message?e.detail.message:"Unknown error"),"error"),i.auth.style.display="block",i.main.style.display="none"}function o(){for(var e in i.auth.style.display="block",i.main.style.display="none",i.formContainer.innerHTML="",i.tabSelector&&(i.tabSelector.innerHTML='<option value="">Loading tabs...</option>'),s={date:null,data:{}},l=null,d)d.hasOwnProperty(e)&&delete d[e]}function h(){if(l)if(window.TrackerSheets){let o={},e=!1;for(var t in d)if(d.hasOwnProperty(t)){var n=d[t].value.trim();if(""!==n){var r=l.columns[t];if(r){if(!window.TrackerSheets.validateData(n,r.type,r.options))return void c("Invalid data for "+t+" (expected "+r.type+")","error");"Number"===r.type?o[t]=parseFloat(n):o[t]=n,e=!0}}}if(e){let t={date:s.date,data:JSON.parse(JSON.stringify(s.data||{}))};window.TrackerSheets.appendEntry(o).then(function(e){var n,r=((t,n,r)=>{var a=[];if(r&&r.headers&&r.columns)for(let e=1;e<r.headers.length;e++){var o=r.headers[e],i=r.columns[o]||{index:0,type:"Text",supported:!0},s=t&&t.data&&void 0!==t.data[o]?t.data[o]:"",l=n&&void 0!==n[o]?n[o]:"";if("Number"===(i.type||"Text")){var c,i=Number(s),d=Number(l),u=isFinite(i),h=isFinite(d),p=u&&h?d!==i:String(l)!==String(s);let e="0",t="neutral";u&&h?(i=0<(d=d-i)?"+":d<0?"-":"",c=Math.abs(d),e=i+c.toLocaleString(void 0,{maximumFractionDigits:2}),t=0<d?"increase":d<0?"decrease":"neutral"):p&&(e=(s||"—")+" → "+(l||"—")),a.push({fieldName:o,previous:u?s:s||"—",current:h?l:l||"—",changeText:e,changed:p,changeClass:t})}else{i=String(l)!==String(s);a.push({fieldName:o,previous:s||"—",current:l||"—",changeText:i?(s||"—")+" → "+(l||"—"):"No change",changed:i,changeClass:i?"changed":"neutral"})}}return a})(t,o,l);if(i.saveFeedback)if(r&&0!==r.length){let t=!1;for(let e=0;e<r.length;e++)if(r[e].changed){t=!0;break}if(t){let t="";for(let e=0;e<r.length;e++){var a=r[e];t+="\n<tr><td>"+a.fieldName+"</td><td>"+a.previous+"</td><td>"+a.current+'</td><td><span style="color:'+("increase"===(n=a.changeClass)?"#2e7d32":"decrease"===n?"#c62828":"changed"===n?"#000000":"#6c757d")+';">'+a.changeText+"</span></td></tr>"}i.saveFeedback.innerHTML='<table class="table table-sm table-striped"><thead><tr><th>Field</th><th>Previous</th><th>Current</th><th>Change</th></tr></thead><tbody>'+t+"</tbody></table>"}else i.saveFeedback.innerHTML='<div class="alert alert-info">No changes</div>'}else i.saveFeedback.innerHTML='<div class="alert alert-info">No changes</div>';i.formPanel&&(i.formPanel.style.display="none"),i.saveFeedbackPanel&&(i.saveFeedbackPanel.style.display="block"),s={date:e.date,data:o},u(),c("Saved successfully!","success")}).catch(function(e){console.error("Save failed:",e),c("Save failed: "+e.message,"error")})}else c("Please enter at least one value","error")}else c("TrackerSheets not available","error");else c("Form not ready","error")}function p(){if(l)if(window.TrackerSheets){let t=window.CONFIG&&window.CONFIG.SHEET_ID;t?window.TrackerSheets.getTabId().then(function(e){e="https://docs.google.com/spreadsheets/d/"+t+"/edit#gid="+e;window.open(e,"_blank")}).catch(function(e){console.error("Failed to get tab ID:",e);e="https://docs.google.com/spreadsheets/d/"+t+"/edit";window.open(e,"_blank"),c("Opened Google Sheets (tab ID not available)","success")}):c("Sheet ID not configured","error")}else c("TrackerSheets not available","error");else c("Sheet data not loaded","error")}document.addEventListener("DOMContentLoaded",function(){if(i.auth=e("authSection"),i.main=e("mainSection"),i.formPanel=e("formPanel"),i.formContainer=e("formContainer"),i.lastDate=e("lastDate"),i.save=e("saveBtn"),i.openSheets=e("openSheetsBtn"),i.status=e("statusMessage"),i.tabSelector=e("tabSelector"),i.saveFeedbackPanel=e("saveFeedbackPanel"),i.saveFeedback=e("saveFeedback"),!i.auth)throw new Error("Missing required element: #authSection");if(!i.main)throw new Error("Missing required element: #mainSection");if(!i.formContainer)throw new Error("Missing required element: #formContainer");if(!i.formPanel)throw new Error("Missing required element: #formPanel");if(!i.save)throw new Error("Missing required element: #saveBtn");if(!i.status)throw new Error("Missing required element: #statusMessage");i.save.addEventListener("click",h),i.openSheets&&i.openSheets.addEventListener("click",p),i.tabSelector&&i.tabSelector.addEventListener("change",r),document.addEventListener("tracker:auth:ready",t),document.addEventListener("tracker:auth:error",a),document.addEventListener("tracker:auth:signout",o)})})();
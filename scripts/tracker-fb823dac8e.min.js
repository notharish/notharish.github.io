window.CONFIG={CLIENT_ID:"209191307792-57cp00mia6fgfc7dj0ohbbgqqtfu45q4.apps.googleusercontent.com",SHEET_ID:"1t73pb_DWXW5hBySNJeIjrkve72pVTae1iaYCj-MMBog",TRACKER_SHEET:"Sheet3",SCOPES:"https://www.googleapis.com/auth/spreadsheets"},(()=>{var t="tracker_oauth_tokens",n=3e5,o={accessToken:null,gapiLoaded:!1,tokenClient:null};function r(){return new Promise(function(e,t){o.gapiLoaded&&gapi.client?e():window.gapi&&gapi.load?gapi.load("client",function(){gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]}).then(function(){o.gapiLoaded=!0,e()}).catch(t)}):t(new Error("gapi not loaded"))})}function a(){try{var e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(e){return console.error("Error reading stored tokens:",e),null}}function i(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){console.error("Error storing tokens:",e)}}function s(){try{localStorage.removeItem(t)}catch(e){console.error("Error clearing tokens:",e)}}function c(e){return e&&e.access_token&&e.expires_at&&Date.now()<e.expires_at-n}function l(){return new Promise(function(t,n){var e,r=a();r&&r.refresh_token?((e=new URLSearchParams).append("client_id",window.CONFIG.CLIENT_ID),e.append("refresh_token",r.refresh_token),e.append("grant_type","refresh_token"),fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(function(e){return e.json()}).then(function(e){e.error?n(new Error("Token refresh failed: "+e.error)):(i(e={access_token:e.access_token,refresh_token:r.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:r.scope,token_type:r.token_type||"Bearer"}),o.accessToken=e.access_token,t(e))}).catch(n)):n(new Error("No refresh token available"))})}function e(){return new Promise(function(n,r){try{var e=(()=>{if(!o.tokenClient){if(!window.google||!google.accounts||!google.accounts.oauth2)throw new Error("Google Identity Services not available");o.tokenClient=google.accounts.oauth2.initTokenClient({client_id:window.CONFIG&&window.CONFIG.CLIENT_ID,scope:window.CONFIG&&window.CONFIG.SCOPES,callback:function(){}})}return o.tokenClient})();e.callback=function(e){var t;e&&e.access_token?(i(t={access_token:e.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:e.scope,token_type:e.token_type||"Bearer"}),o.accessToken=e.access_token,n(t)):r(new Error("No access token"))},e.requestAccessToken({prompt:""})}catch(e){r(e)}})}function u(){e().then(function(e){return r().then(function(){return e})}).then(function(e){gapi.client.setToken({access_token:e.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:e.access_token,tokenData:e}}))}).catch(function(e){console.error("Sign-in error:",e),s(),document.dispatchEvent(new CustomEvent("tracker:auth:error",{detail:e}))})}function d(){var e,t=document.getElementById("googleSignInBtn"),n=(t&&t.addEventListener("click",u),a());n&&c(n)&&(o.accessToken=n.access_token,window.gapi&&window.gapi.load?r().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),s()}):(e=function(){window.gapi&&window.gapi.load?r().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),s()}):setTimeout(e,100)})())}document.addEventListener("DOMContentLoaded",d),window.TrackerAuth={getToken:function(){return a()||null},clearTokens:function(){s(),o.accessToken=null,document.dispatchEvent(new CustomEvent("tracker:auth:signout"))},isAuthenticated:function(){var e=a();return!(!e||!c(e))},refreshToken:l,initAuthUI:d,onSignInClick:u,withValidToken:function(r){return new Promise(function(t,n){var e=a();e&&c(e)?(o.accessToken=e.access_token,gapi.client.setToken({access_token:e.access_token}),r().then(t).catch(n)):e&&e.refresh_token?l().then(function(e){gapi.client.setToken({access_token:e.access_token}),r().then(t).catch(n)}).catch(function(e){s(),n(new Error("Token refresh failed, please sign in again"))}):n(new Error("No valid token available, please sign in"))})}}})(),(()=>{var l=window.CONFIG&&window.CONFIG.SHEET_ID||"",f=window.CONFIG&&window.CONFIG.TRACKER_SHEET||"Sheet3",m=["Date","Number","Text","Dropdown"],w=null;let u="A";function d(e,t,n){if(null==e||""===e)return!1;switch(t){case"Date":return!isNaN(Date.parse(e));case"Number":return!isNaN(parseFloat(e))&&isFinite(e);case"Text":return"string"==typeof e||"number"==typeof e;case"Dropdown":return!(!n||!n.includes(e));default:return!1}}function e(){return w?Promise.resolve(w):window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.get({spreadsheetId:l,fields:"sheets(properties(sheetId,title),tables(tableId,name,range,columnProperties(columnIndex,columnName,columnType,dataValidationRule(condition(type,values(userEnteredValue))))))"})}).then(function(e){for(var t=e&&e.result&&e.result.sheets||[],n=null,r=0;r<t.length;r++)if(t[r]&&t[r].properties&&t[r].properties.title===f){n=t[r];break}if(!n)throw new Error("Sheet not found: "+f);var e=n.properties.sheetId,o=n.tables||[];if(0===o.length)throw new Error("No tables found in sheet: "+f);var a=o[0].columnProperties||[];if(0===a.length)throw new Error("No column properties found in table");if("Date"!==a[0].columnName)throw new Error('First column must be "Date"');for(var i={},s=[],c=0;c<a.length;c++){var l=a[c],u=l.columnName,d=l.columnType,p=(s.push(u),"Text"),h=null;d&&("DATE"===(d=String(d).toUpperCase())||"DATE_TIME"===d||"TIME_DATE"===d?p="Date":"NUMBER"===d||"PERCENT"===d||"CURRENCY"===d||"SCIENTIFIC"===d?p="Number":"TEXT"===d?p="Text":"DROPDOWN"===d&&(p="Dropdown",l.dataValidationRule)&&l.dataValidationRule.condition&&"ONE_OF_LIST"===l.dataValidationRule.condition.type&&l.dataValidationRule.condition.values&&(h=l.dataValidationRule.condition.values.map(function(e){return e.userEnteredValue}))),i[u]={index:l.columnIndex,type:p,supported:m.includes(p),options:h}}return w={columns:i,headers:s,dateColumn:"Date",sheetId:e}})}window.TrackerSheets={readLastEntry:function(){return e().then(function(i){var e=f+"!2:2";return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.get({spreadsheetId:l,range:e,majorDimension:"ROWS"})}).then(function(e){var t=e&&e.result&&e.result.values&&e.result.values[0]||null;if(!t||0===t.length||!t[0])return{date:null,data:{}};var n,r={date:t[0],data:{}};for(n in i.columns){var o=i.columns[n],a=t[o.index];void 0!==a&&""!==a&&("Number"===o.type?r.data[n]=parseFloat(a):(o.type,r.data[n]=a))}return r})})},appendEntry:function(c){return e().then(function(e){for(var t in c)if("Date"!==t){var n=e.columns[t];if(!n)throw new Error("Unknown column: "+t);if(!n.supported)throw new Error("Unsupported column type: "+t+" ("+n.type+")");if(!d(c[t],n.type,n.options))throw new Error("Invalid data for column "+t+": expected "+n.type)}var r=new Array(e.headers.length);r[0]=(new Date).toISOString().split("T")[0];for(var o=1;o<e.headers.length;o++){var a=e.headers[o],a=c[a]||"";r[o]=a}var i={values:[r]},s=(e=>{for(var t=e+1,n="";0<t;)var r=(t-1)%26,n=String.fromCharCode(u.charCodeAt(0)+r)+n,t=Math.floor((t-r)/26);return n})(e.headers.length-1);if(e.sheetId)return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:l,resource:{requests:[{insertDimension:{range:{sheetId:e.sheetId,dimension:"ROWS",startIndex:1,endIndex:2},inheritFromBefore:!1}}]}})}).then(function(){return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.update({spreadsheetId:l,range:f+"!A2:"+s+"2",valueInputOption:"USER_ENTERED",resource:i})})}).then(function(){return{ok:!0,date:r[0],data:c}});throw new Error("Sheet ID not available in column metadata.")})},getColumnMetadata:e,validateData:d,clearCache:function(){w=null}}})(),(()=>{var i={},s={date:null,data:{}},c=null,l={};function e(e){return document.getElementById(e)}function a(e,t){i.status.textContent=e,i.status.className="alert "+("error"===t?"alert-danger":"alert-success"),i.status.style.display="block",setTimeout(function(){i.status.style.display="none"},3e3)}function n(e){c=e,i.formContainer.innerHTML="";for(var t=e.headers,n=e.columns,r=1;r<t.length;r++){var o=t[r],a=n[o];a&&a.supported&&(a=((e,t,n)=>{var r,o=document.createElement("div"),a=(o.className="form-group",document.createElement("label"));if(a.textContent=e,a.setAttribute("for","input_"+e),a.style.display="block",a.style.marginBottom="5px",a.style.fontWeight="500","Dropdown"===t.type){(r=document.createElement("select")).id="input_"+e,r.name=e,r.className="form-control",r.style.textAlign="center";var i=document.createElement("option");if(i.value="",i.textContent="Select "+e.toLowerCase(),r.appendChild(i),t.options&&0<t.options.length)for(var s=0;s<t.options.length;s++){var c=document.createElement("option");c.value=t.options[s],c.textContent=t.options[s],n===t.options[s]&&(c.selected=!0),r.appendChild(c)}}else switch((r=document.createElement("input")).id="input_"+e,r.name=e,r.className="form-control",r.style.textAlign="center",t.type){case"Date":r.type="date",r.value=n||"";break;case"Number":r.type="number",r.step="0.1",r.placeholder="e.g. 175.2",r.value=n||"";break;case"Text":r.type="text",r.placeholder="Enter "+e.toLowerCase(),r.value=n||"";break;default:r.type="text",r.value=n||""}return o.appendChild(a),o.appendChild(r),l[e]=r,o})(o,a,s.data[o]||""),i.formContainer.appendChild(a))}}function u(){s.date?i.lastDate.textContent="Last updated: "+new Date(s.date).toLocaleString():i.lastDate.textContent="No previous entries"}function t(){i.auth.style.display="none",i.main.style.display="block",Promise.all([window.TrackerSheets.getColumnMetadata(),window.TrackerSheets.readLastEntry()]).then(function(e){var t=e[0];s=e[1],n(t),u()}).catch(function(e){console.error("Failed to load data:",e),a("Failed to load data: "+e.message,"error"),(e.message.includes("token")||e.message.includes("sign in"))&&(i.auth.style.display="block",i.main.style.display="none")})}function r(e){console.error("Authentication error:",e.detail),a("Authentication failed: "+e.detail.message,"error"),i.auth.style.display="block",i.main.style.display="none"}function o(){i.auth.style.display="block",i.main.style.display="none",i.formContainer.innerHTML="",s={date:null,data:{}},c=null,l={}}function d(){if(c){var e,n={},t=!1;for(e in l){var r=l[e].value.trim();if(""!==r){var o=c.columns[e];if(!window.TrackerSheets.validateData(r,o.type,o.options))return void a("Invalid data for "+e+" (expected "+o.type+")","error");"Number"===o.type?n[e]=parseFloat(r):n[e]=r,t=!0}}t?window.TrackerSheets.appendEntry(n).then(function(e){for(var t in s={date:e.date,data:n},u(),a("Saved successfully!","success"),l)l[t].value=""}).catch(function(e){console.error("Save failed:",e),a("Save failed: "+e.message,"error")}):a("Please enter at least one value","error")}else a("Form not ready","error")}document.addEventListener("DOMContentLoaded",function(){if(i.auth=e("authSection"),i.main=e("mainSection"),i.formContainer=e("formContainer"),i.lastDate=e("lastDate"),i.save=e("saveBtn"),i.status=e("statusMessage"),!i.auth)throw new Error("Missing required element: #authSection");if(!i.main)throw new Error("Missing required element: #mainSection");if(!i.formContainer)throw new Error("Missing required element: #formContainer");if(!i.save)throw new Error("Missing required element: #saveBtn");if(!i.status)throw new Error("Missing required element: #statusMessage");i.save.addEventListener("click",d),document.addEventListener("tracker:auth:ready",t),document.addEventListener("tracker:auth:error",r),document.addEventListener("tracker:auth:signout",o)})})();
window.CONFIG={CLIENT_ID:"209191307792-57cp00mia6fgfc7dj0ohbbgqqtfu45q4.apps.googleusercontent.com",SHEET_ID:"1t73pb_DWXW5hBySNJeIjrkve72pVTae1iaYCj-MMBog",TRACKER_SHEET:"Sheet3",SCOPES:"https://www.googleapis.com/auth/spreadsheets"},(()=>{var r={accessToken:null,gapiLoaded:!1,tokenClient:null};function e(){return new Promise(function(e,t){r.gapiLoaded&&gapi.client?e():window.gapi&&gapi.load?gapi.load("client",function(){gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]}).then(function(){r.gapiLoaded=!0,e()}).catch(t)}):t(new Error("gapi not loaded"))})}function t(){return new Promise(function(t,n){try{var e=(()=>{if(!r.tokenClient){if(!window.google||!google.accounts||!google.accounts.oauth2)throw new Error("Google Identity Services not available");r.tokenClient=google.accounts.oauth2.initTokenClient({client_id:window.CONFIG&&window.CONFIG.CLIENT_ID,scope:window.CONFIG&&window.CONFIG.SCOPES,callback:function(){}})}return r.tokenClient})();e.callback=function(e){e&&e.access_token?(r.accessToken=e.access_token,t(e.access_token)):n(new Error("No access token"))},e.requestAccessToken({prompt:""})}catch(e){n(e)}})}function n(){t().then(e).then(function(){gapi.client.setToken({access_token:r.accessToken}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:r.accessToken}}))}).catch(function(e){console.error(e)})}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("googleSignInBtn");e&&e.addEventListener("click",n)}),window.TrackerAuth={getToken:function(){return r.accessToken}}})(),(()=>{var u=window.CONFIG&&window.CONFIG.SHEET_ID||"",h=window.CONFIG&&window.CONFIG.TRACKER_SHEET||"Sheet3",m=["Date","Number","Text"],f=null;let c="A";function d(e,t){if(null==e||""===e)return!1;switch(t){case"Date":return!isNaN(Date.parse(e));case"Number":return!isNaN(parseFloat(e))&&isFinite(e);case"Text":return"string"==typeof e||"number"==typeof e;default:return!1}}function e(){return f?Promise.resolve(f):gapi.client.sheets.spreadsheets.get({spreadsheetId:u,fields:"sheets(properties(sheetId,title),tables(tableId,name,range,columnProperties(columnIndex,columnName,columnType,dataValidationRule(condition(type,values(userEnteredValue))))))"}).then(function(e){for(var t=e&&e.result&&e.result.sheets||[],n=null,r=0;r<t.length;r++)if(t[r]&&t[r].properties&&t[r].properties.title===h){n=t[r];break}if(!n)throw new Error("Sheet not found: "+h);var e=n.properties.sheetId,a=n.tables||[];if(0===a.length)throw new Error("No tables found in sheet: "+h);var o=a[0].columnProperties||[];if(0===o.length)throw new Error("No column properties found in table");if("Date"!==o[0].columnName)throw new Error('First column must be "Date"');for(var s={},i=[],l=0;l<o.length;l++){var u=o[l],c=u.columnName,d=u.columnType,p=(i.push(c),"Text");d&&("DATE"===(d=String(d).toUpperCase())||"DATE_TIME"===d||"TIME_DATE"===d?p="Date":"NUMBER"===d||"PERCENT"===d||"CURRENCY"===d||"SCIENTIFIC"===d?p="Number":"TEXT"===d&&(p="Text")),s[c]={index:u.columnIndex,type:p,supported:m.includes(p)}}return f={columns:s,headers:i,dateColumn:"Date",sheetId:e}})}window.TrackerSheets={readLastEntry:function(){return e().then(function(s){return gapi.client.sheets.spreadsheets.values.get({spreadsheetId:u,range:h+"!2:2",majorDimension:"ROWS"}).then(function(e){var t=e&&e.result&&e.result.values&&e.result.values[0]||null;if(!t||0===t.length||!t[0])return{date:null,data:{}};var n,r={date:t[0],data:{}};for(n in s.columns){var a=s.columns[n],o=t[a.index];void 0!==o&&""!==o&&("Number"===a.type?r.data[n]=parseFloat(o):(a.type,r.data[n]=o))}return r})})},appendEntry:function(l){return e().then(function(e){for(var t in l)if("Date"!==t){var n=e.columns[t];if(!n)throw new Error("Unknown column: "+t);if(!n.supported)throw new Error("Unsupported column type: "+t+" ("+n.type+")");if(!d(l[t],n.type))throw new Error("Invalid data for column "+t+": expected "+n.type)}var r=new Array(e.headers.length);r[0]=(new Date).toISOString().split("T")[0];for(var a=1;a<e.headers.length;a++){var o=e.headers[a],o=l[o]||"";r[a]=o}var s={values:[r]},i=(e=>{for(var t=e+1,n="";0<t;)var r=(t-1)%26,n=String.fromCharCode(c.charCodeAt(0)+r)+n,t=Math.floor((t-r)/26);return n})(e.headers.length-1);if(e.sheetId)return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:u,resource:{requests:[{insertDimension:{range:{sheetId:e.sheetId,dimension:"ROWS",startIndex:1,endIndex:2},inheritFromBefore:!1}}]}}).then(function(){return gapi.client.sheets.spreadsheets.values.update({spreadsheetId:u,range:h+"!A2:"+i+"2",valueInputOption:"USER_ENTERED",resource:s})}).then(function(){return{ok:!0,date:r[0],data:l}});throw new Error("Sheet ID not available in column metadata.")})},getColumnMetadata:e,validateData:d}})(),(()=>{var s={},i={date:null,data:{}},l=null,u={};function e(e){return document.getElementById(e)}function o(e,t){s.status.textContent=e,s.status.className="alert "+("error"===t?"alert-danger":"alert-success"),s.status.style.display="block",setTimeout(function(){s.status.style.display="none"},3e3)}function n(e){l=e,s.formContainer.innerHTML="";for(var t=e.headers,n=e.columns,r=1;r<t.length;r++){var a=t[r],o=n[a];o&&o.supported&&(o=((e,t,n)=>{var r=document.createElement("div"),a=(r.className="form-group",document.createElement("label")),o=(a.textContent=e,a.setAttribute("for","input_"+e),a.style.display="block",a.style.marginBottom="5px",a.style.fontWeight="500",document.createElement("input"));switch(o.id="input_"+e,o.name=e,o.className="form-control",o.style.textAlign="center",t.type){case"Date":o.type="date",o.value=n||"";break;case"Number":o.type="number",o.step="0.1",o.placeholder="e.g. 175.2",o.value=n||"";break;case"Text":o.type="text",o.placeholder="Enter "+e.toLowerCase(),o.value=n||"";break;default:o.type="text",o.value=n||""}return r.appendChild(a),r.appendChild(o),u[e]=o,r})(a,o,i.data[a]||""),s.formContainer.appendChild(o))}}function c(){i.date?s.lastDate.textContent="Last updated: "+new Date(i.date).toLocaleString():s.lastDate.textContent="No previous entries"}function t(){s.auth.style.display="none",s.main.style.display="block",Promise.all([window.TrackerSheets.getColumnMetadata(),window.TrackerSheets.readLastEntry()]).then(function(e){var t=e[0];i=e[1],n(t),c()}).catch(function(e){console.error("Failed to load data:",e),o("Failed to load data: "+e.message,"error")})}function r(){if(l){var e,n={},t=!1;for(e in u){var r=u[e].value.trim();if(""!==r){var a=l.columns[e];if(!window.TrackerSheets.validateData(r,a.type))return void o("Invalid data for "+e+" (expected "+a.type+")","error");"Number"===a.type?n[e]=parseFloat(r):n[e]=r,t=!0}}t?window.TrackerSheets.appendEntry(n).then(function(e){for(var t in i={date:e.date,data:n},c(),o("Saved successfully!","success"),u)u[t].value=""}).catch(function(e){console.error("Save failed:",e),o("Save failed: "+e.message,"error")}):o("Please enter at least one value","error")}else o("Form not ready","error")}document.addEventListener("DOMContentLoaded",function(){if(s.auth=e("authSection"),s.main=e("mainSection"),s.formContainer=e("formContainer"),s.lastDate=e("lastDate"),s.save=e("saveBtn"),s.status=e("statusMessage"),!s.auth)throw new Error("Missing required element: #authSection");if(!s.main)throw new Error("Missing required element: #mainSection");if(!s.formContainer)throw new Error("Missing required element: #formContainer");if(!s.save)throw new Error("Missing required element: #saveBtn");if(!s.status)throw new Error("Missing required element: #statusMessage");s.save.addEventListener("click",r),document.addEventListener("tracker:auth:ready",t)})})();
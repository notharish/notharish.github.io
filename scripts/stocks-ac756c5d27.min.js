"use strict";function initializeStocks(){$("#addStockInput").change(addStock),$("#addedStocks").on("click",".deleterow",deleteStock);for(var t=0;t<SAMPLE_DATA.tickers.length;++t)addStockCallback(SAMPLE_DATA.tickers[t])}function addStock(){var t=$("#addStockInput").val();$("#addStockInput").val(""),$.get("/api/stocks/ticker/"+t+"/",addStockCallback)}function addStockCallback(t){var a=createRow('<a target="_blank" href="http://finance.yahoo.com/q?s='+t.ticker+'">'+t.ticker+"</a>",t.name,t.firstDate,'<div class="deleterow"><div class="glyphicon glyphicon-remove"></div></div>');$("#addedStocks").append(a)}function getTickers(){for(var t=$("#addedStocks>tr"),a=[],e=0;e<t.length;++e){var i=t[e],r=$("a",i).first().text();a.push(r)}return a}function deleteStock(){var t=$(this).closest("tr");t.addClass("danger"),t.fadeOut(1e3,function(){t.remove()})}function createRow(){for(var t="<tr>",a=0;a<arguments.length;++a)t+="<td>"+arguments[a]+"</td>";return t+="</tr>"}function initializeHistoricalData(){$("#futureCorrelation").on("change","input",updateCorrelation),$("#historicalData").click(calculateHistoricalData),$("#from").datepicker({changeMonth:!0,changeYear:!0,numberOfMonths:1,dateFormat:"yy-mm-dd",onClose:function(t){$("#to").datepicker("option","minDate",t)}}),$("#from").datepicker("setDate","2005-3-17"),$("#to").datepicker({changeMonth:!0,changeYear:!0,numberOfMonths:1,dateFormat:"yy-mm-dd",onClose:function(t){$("#from").datepicker("option","maxDate",t)}}),$("#to").datepicker("setDate","2015-3-17"),$("#positiveWeights").change(handlePositiveWeightsChange),calculateHistoricalDataCallback(SAMPLE_DATA.historicalData)}function getISODateOnlyValue(t){return t.getFullYear()+"-"+(t.getMonth()+1)+"-"+t.getDate()}function getHistoricalDataParams(){var t=$("#from").datepicker("getDate"),a=$("#to").datepicker("getDate"),e=getTickers();return{startDate:getISODateOnlyValue(t),endDate:getISODateOnlyValue(a),tickers:e}}function calculateHistoricalData(){$.post("/api/stocks/historicalData/",getHistoricalDataParams()).done(calculateHistoricalDataCallback)}function calculateHistoricalDataCallback(t){$("#historicalDataContainer").show();var a,e="<tr><td></td>",i=t.tickers;for(a=0;a<i.length;++a)e+="<th>"+i[a]+"</th>";e+="</tr>";var r=t.correlation;for(a=0;a<r.length;++a){e+="<tr><th>"+i[a]+"</th>";for(var n=0;n<r[a].length;++n)e+="<td>"+r[a][n].toFixed(2)+"</td>";e+="</tr>"}for($("#correlationTable").html(e),e="",a=0;a<i.length;++a){var o=t.tickerData[a];e+=createRow(i[a],(100*o.annualReturnRate).toFixed(2)+"%",o.standardDeviation.toFixed(8),o.sharpeRatio.toFixed(4),o.VaR.toFixed(8),o.meanDailyReturn.toFixed(8))}$("#historicalDataTable").html(e),prefillForm(t)}function prefillForm(t){var a,e="<tr><th></th>",i=t.tickers;for(a=0;a<i.length;++a)e+="<th>"+i[a]+"</th>";e+="</tr>";var r=t.correlation;for(a=0;a<r.length;++a){e+="<tr><th>"+i[a]+"</th>";for(var n=0;n<r[a].length;++n){var o=n>a?"":" disabled ",s=' id="corr-'+a+"-"+n+'" ';e+='<td><input type="number" step="any" max="1" min="-1" class="form-control input_short"'+o+s+' value="'+r[a][n].toFixed(2)+'"></td>'}e+="</tr>"}for($("#futureCorrelation").html(e),e="",a=0;a<i.length;++a){var c=i[a],l=t.tickerData[a],h=(100*l.annualReturnRate).toFixed(2),d=l.standardDeviation.toFixed(8);e+=createRow('<a target="_blank" href="http://finance.yahoo.com/q?s='+c+'">'+c+"</a>",'<div class="slider-value">-1 to 1</div><div class="slider"></div>','<input type="number" step="any" class="form-control" value="'+h+'">','<input type="number" step="any" min="0" class="form-control" value="'+d+'">')}$("#stockList").html(e),$("#stockList .slider").slider({range:!0,min:-100,max:100,values:[-100,100],change:function(t,a){$(this).prev().text(a.values[0]/100+" to "+a.values[1]/100)}})}function handlePositiveWeightsChange(){for(var t=$(this).prop("checked")?0:-100,a=$("#stockList>tr"),e=0;e<a.length;++e){var i=a[e];$(".slider",i).slider("values",0,t)}}function updateCorrelation(){var t=$(this),a=t.attr("id"),e=a.split("-");$("#"+e[0]+"-"+e[2]+"-"+e[1]).val(t.val())}function Graph(t){this.canvas=document.getElementById(t.canvasId),this.minX=t.minX,this.minY=t.minY,this.maxX=t.maxX,this.maxY=t.maxY,this.xTicks=t.xTicks,this.yTicks=t.yTicks,this.xSuffix=t.xSuffix,this.ySuffix=t.ySuffix,this.marginX=40,this.marginY=40,this.axisColor="#aaa",this.tickColor="rgba(128, 128, 255, 0.5)",this.font="12pt Helvetica",this.tickSize=20,this.context=this.canvas.getContext("2d"),this.centerY=this.canvas.height-this.marginY,this.centerX=this.marginX,this.scaleX=(this.canvas.width-2*this.marginX)/(this.maxX-this.minX),this.scaleY=(this.canvas.height-2*this.marginY)/(this.maxY-this.minY),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawHeader(t.header),this.drawXAxis(),this.drawYAxis()}function initializeCalculator(){$("#calculatorForm").submit(calculate),calculatorCallback(SAMPLE_DATA.calculatorData)}function getCalculatorParams(){var t={};t.tickers=getTickers(),t.riskFreeReturn=$("#riskFreeReturn").val(),t.expectedReturn=$("#expectedReturn").val();var a=$("#stockList>tr"),e=0;for(t.upperBounds=[],t.lowerBounds=[],t.returnRate=[],t.stdDeviation=[],e=0;e<a.length;++e){var i=a[e],r=$(".slider",i).slider("values");t.lowerBounds.push(r[0]/100),t.upperBounds.push(r[1]/100);var n=$("input",i);t.returnRate.push(parseFloat($(n[0]).val())),t.stdDeviation.push(parseFloat($(n[1]).val()))}t.correlation=[];var o,s=$("#futureCorrelation input"),c=t.lowerBounds.length;for(e=0;e<s.length;++e)e%c===0&&(o=[],t.correlation.push(o)),o.push(parseFloat($(s[e]).val()));return t}function calculate(t){t.preventDefault();var a=getCalculatorParams();$.post("/api/stocks/calculate/",a).done(calculatorCallback)}function calculatorCallback(t){var a=drawEfficientFrontier(t.efficientFrontier);addPortfolio("mvp",t.mvp,a,"#f39c12"),addPortfolio("gmvp",t.gmvp,a,"#3498db"),addPortfolio("tangentPortfolio",t.tangentPortfolio,a,"#18bc9c")}function addPortfolio(t,a,e,i){for(var r='<table class="table table-bordered"><tr><th>Stock</th><th>Weight</th></tr>',n=a.weights,o=a.tickers,s=0;s<n.length;++s)r+="<tr><td>"+o[s]+"</td>",r+="<td>"+n[s].toFixed(4)+"</td></tr>";r+="</table>",r+='<table class="table table-bordered">',r+="<tr><th>Annual return rate</th><td>"+(100*a.annualReturnRate).toFixed(2)+"%</td>",r+="<tr><th>Standard Deviation</th><td>"+a.standardDeviation.toFixed(8)+"</td>",r+="<tr><th>Variance</th><td>"+(1e6*a.variance).toFixed(4)+"e-06</td>",r+="<tr><th>Value at Risk</th><td>"+a.VaR.toFixed(8)+"</td>",r+="</table>",$("#"+t).html(r),e.drawPoint(1e6*a.variance,100*a.annualReturnRate,i)}function drawEfficientFrontier(t){$("#efResult").show();var a=1e6*t.start[1],e=100*t.start[0],i=1e6*t.control[1],r=100*t.control[0],n=1e6*t.end[1],o=100*t.end[0],s=1e6*t.mid[1],c=100*t.mid[0],l=1e6*t.tangency[1],h=100*t.tangency[0],d=100*t.riskFreeReturn,u=Math.max(a,i,n,s);u=10*Math.ceil(u/10);var v=Math.max(e,r,o,c);v=10*Math.ceil(v/10);var f=Math.min(a,i,n,s);f=Math.max(f,0),f=10*Math.floor(f/10);var m=Math.min(e,r,o,c);m=Math.max(m,0),m=10*Math.floor(m/10);var k=new Graph({canvasId:"efCanvas",minX:f,minY:m,maxX:u,maxY:v,xTicks:10,yTicks:10,xSuffix:"%",ySuffix:"",header:"Annual Return(%) vs Variance(e-06)"});k.drawQuadraticCurve(a,e,i,r,n,o);var p=(h-d)/(l-0),g=(v-d)/(u-0),x=0,D=0;return g>p?(x=u,D=p*u+d):(D=v,x=(v-d)/p),k.drawLine(0,d,x,D),k}var SAMPLE_DATA={};SAMPLE_DATA.tickers=[{ticker:"SPY",name:"SPDR S&P 500",firstDate:"1993-01-29"},{ticker:"EFA",name:"iShares MSCI EAFE ETF",firstDate:"2001-08-27"},{ticker:"VWO",name:"Vanguard FTSE Emerging Markets ",firstDate:"2005-03-10"},{ticker:"GLD",name:"SPDR Gold Trust",firstDate:"2004-11-18"},{ticker:"AGG",name:"iShares Core U.S. Aggregate Bond Fund",firstDate:"2003-09-29"},{ticker:"TIP",name:"iShares TIPS Bond ETF",firstDate:"2003-12-05"}],SAMPLE_DATA.historicalData={tickerData:[{standardDeviation:.012851416401751236,annualReturnRate:.07864592499838685,sharpeRatio:0,VaR:2.1134841586170787,variance:.00016515890353120067,meanDailyReturn:.00038492364989367573},{standardDeviation:.015561272287557465,annualReturnRate:.044363989405868276,sharpeRatio:-.014154722677019818,VaR:2.559306127564274,variance:.00024215319520750394,meanDailyReturn:.00029441303630186433},{standardDeviation:.02012384951030825,annualReturnRate:.07579540895391346,sharpeRatio:.009837069621632747,VaR:3.3095855877600666,variance:.0004049693191135336,meanDailyReturn:.0004918360978387851},{standardDeviation:.01290038244737506,annualReturnRate:.0965613313895517,sharpeRatio:.0036625628206397656,VaR:2.1214737526338374,variance:.00016641986728854256,meanDailyReturn:.0004495243373835655},{standardDeviation:.0032997239909671656,annualReturnRate:.046338073526154044,sharpeRatio:-.014623333362216821,VaR:.5425701081051808,variance:1088817841656428e-20,meanDailyReturn:.00018598246625067442},{standardDeviation:.004203631297312802,annualReturnRate:.0420153345883314,sharpeRatio:-.01471566480128783,VaR:.6912623303927926,variance:17670516083747713e-21,meanDailyReturn:.00017322463509287394}],tickers:["SPY","EFA","VWO","GLD","AGG","TIP"],correlation:[[1,.9161316524220299,.8738841455070866,.06175298637602889,-.1064905146577137,-.22330020436754566],[.9161316524220299,1,.8923734335021647,.1765042654867296,-.058438689074045425,-.16646278967153436],[.8738841455070866,.8923734335021647,1,.1922341741744804,-.07809248321305606,-.17590698580788713],[.06175298637602889,.1765042654867296,.1922341741744804,1,.10979379422900833,.20108489770897003],[-.1064905146577137,-.058438689074045425,-.07809248321305606,.10979379422900833,1,.6080587939916597],[-.22330020436754566,-.16646278967153436,-.17590698580788713,.20108489770897003,.6080587939916597,1]]},SAMPLE_DATA.calculatorData={mvp:{annualReturnRate:.08000000000000008,standardDeviation:.004202280863104428,weights:[.701237811733559,-.5327292980842173,.0007833092715542653,.196608992336692,.6632371095330271,-.029137924790615014],VaR:.6112134284519908,variance:17659164452413697e-21,tickers:["SPY","EFA","VWO","GLD","AGG","TIP"]},tangentPortfolio:{annualReturnRate:.06194722931658132,standardDeviation:.0030834516228406823,weights:[.37235015356149376,-.22713035060696157,-.020148114795258906,.08663274799426021,.6546941342512755,.13360142959519108],VaR:.44523523590185515,variance:9507673910398837e-21,tickers:["SPY","EFA","VWO","GLD","AGG","TIP"]},gmvp:{annualReturnRate:.052849431567163936,standardDeviation:.0029114652207462254,weights:[.20660532382587368,-.07312199751275338,-.03069662937287436,.03120958706293531,.6503888670545231,.21561484894229568],VaR:.42604379870684517,variance:8476629731614866e-21,tickers:["SPY","EFA","VWO","GLD","AGG","TIP"]},efficientFrontier:{control:[.0483,-20325775085910448e-21],end:[.0966,3232024620110564e-20],mid:[.0483,8734451168980125e-21],riskFreeReturn:.02,start:[0,4326910864663575e-20],tangency:[.06194722931658131,9507673910398828e-21]}},$(document).ready(function(){initializeStocks()}),$(document).ready(function(){initializeHistoricalData()}),Graph.prototype.calcX=function(t){return this.centerX+this.scaleX*(t-this.minX)},Graph.prototype.calcY=function(t){return this.centerY-this.scaleY*(t-this.minY)},Graph.prototype.drawHeader=function(t){var a=this.context;a.save(),a.font=this.font,a.textAlign="center",a.textBaseline="top",a.fillText(t,this.canvas.width/2,0),a.restore()},Graph.prototype.drawQuadraticCurve=function(t,a,e,i,r,n){var o=this.context;o.save(),o.beginPath(),o.moveTo(this.calcX(t),this.calcY(a)),o.lineWidth=2,o.quadraticCurveTo(this.calcX(e),this.calcY(i),this.calcX(r),this.calcY(n)),o.stroke(),o.restore()},Graph.prototype.drawPoint=function(t,a,e){var i=this.context;i.save(),i.beginPath(),i.arc(this.calcX(t),this.calcY(a),6,0,2*Math.PI,!1),i.fillStyle=e,i.fill(),i.restore()},Graph.prototype.drawLine=function(t,a,e,i){var r=this.context;r.save(),r.strokeStyle="#ff7f50",r.lineWidth=1,r.beginPath(),r.moveTo(this.calcX(t),this.calcY(a)),r.lineTo(this.calcX(e),this.calcY(i)),r.stroke(),r.restore()},Graph.prototype.drawXAxis=function(){var t=this.context;t.save(),t.beginPath(),t.moveTo(this.centerX,this.centerY),t.lineTo(this.canvas.width-this.marginX,this.centerY),t.strokeStyle=this.axisColor,t.lineWidth=2,t.stroke(),t.font=this.font,t.textAlign="center",t.textBaseline="top",t.strokeStyle=this.tickColor,t.lineWidth=1,t.beginPath();var a=(this.canvas.width-2*this.marginX)/this.xTicks,e=(this.maxX-this.minX)/this.xTicks;t.fillText(this.minX+this.ySuffix,this.centerX,this.centerY+3);for(var i=1;i<=this.xTicks;++i){var r=this.centerX+i*a;t.moveTo(r,this.centerY),t.lineTo(r,this.marginY),t.fillText(this.minX+i*e+this.ySuffix,r,this.centerY+3)}t.stroke(),t.restore()},Graph.prototype.drawYAxis=function(){var t=this.context;t.save(),t.beginPath(),t.moveTo(this.centerX,this.centerY),t.lineTo(this.centerX,this.marginY),t.strokeStyle=this.axisColor,t.lineWidth=2,t.stroke(),t.strokeStyle=this.tickColor,t.lineWidth=1,t.beginPath(),t.font=this.font,t.textAlign="right",t.textBaseline="middle";var a=(this.canvas.height-2*this.marginY)/this.yTicks,e=(this.maxY-this.minY)/this.yTicks;t.fillText(this.minY+this.xSuffix,this.centerX-3,this.centerY);for(var i=1;i<=this.yTicks;++i){var r=this.centerY-i*a;t.moveTo(this.centerX,r),t.lineTo(this.canvas.width-this.marginY,r),t.fillText(this.minY+i*e+this.xSuffix,this.centerX-3,r)}t.stroke(),t.restore()},$(document).ready(function(){initializeCalculator()});
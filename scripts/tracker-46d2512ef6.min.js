window.CONFIG={CLIENT_ID:"209191307792-57cp00mia6fgfc7dj0ohbbgqqtfu45q4.apps.googleusercontent.com",SHEET_ID:"1t73pb_DWXW5hBySNJeIjrkve72pVTae1iaYCj-MMBog",SCOPES:"https://www.googleapis.com/auth/spreadsheets"},(()=>{var t="tracker_oauth_tokens",n=3e5,r={accessToken:null,gapiLoaded:!1,tokenClient:null};function a(){return new Promise(function(e,t){r.gapiLoaded&&gapi.client?e():window.gapi&&gapi.load?gapi.load("client",function(){gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]}).then(function(){r.gapiLoaded=!0,e()}).catch(t)}):t(new Error("gapi not loaded"))})}function o(){try{var e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(e){return console.error("Error reading stored tokens:",e),null}}function s(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){console.error("Error storing tokens:",e)}}function i(){try{localStorage.removeItem(t)}catch(e){console.error("Error clearing tokens:",e)}}function c(e){return e&&e.access_token&&e.expires_at&&Date.now()<e.expires_at-n}function l(){return new Promise(function(t,n){var e,a=o();a&&a.refresh_token?((e=new URLSearchParams).append("client_id",window.CONFIG.CLIENT_ID),e.append("refresh_token",a.refresh_token),e.append("grant_type","refresh_token"),fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(function(e){return e.json()}).then(function(e){e.error?n(new Error("Token refresh failed: "+e.error)):(s(e={access_token:e.access_token,refresh_token:a.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:a.scope,token_type:a.token_type||"Bearer"}),r.accessToken=e.access_token,t(e))}).catch(n)):n(new Error("No refresh token available"))})}function e(){return new Promise(function(n,a){try{var e=(()=>{if(!r.tokenClient){if(!window.google||!google.accounts||!google.accounts.oauth2)throw new Error("Google Identity Services not available");r.tokenClient=google.accounts.oauth2.initTokenClient({client_id:window.CONFIG&&window.CONFIG.CLIENT_ID,scope:window.CONFIG&&window.CONFIG.SCOPES,callback:function(){}})}return r.tokenClient})();e.callback=function(e){var t;e&&e.access_token?(s(t={access_token:e.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:e.scope,token_type:e.token_type||"Bearer"}),r.accessToken=e.access_token,n(t)):a(new Error("No access token"))},e.requestAccessToken({prompt:""})}catch(e){a(e)}})}function d(){e().then(function(e){return a().then(function(){return e})}).then(function(e){gapi.client.setToken({access_token:e.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:e.access_token,tokenData:e}}))}).catch(function(e){console.error("Sign-in error:",e),i(),document.dispatchEvent(new CustomEvent("tracker:auth:error",{detail:e}))})}function u(){var e,t=document.getElementById("googleSignInBtn"),n=(t&&t.addEventListener("click",d),o());n&&c(n)&&(r.accessToken=n.access_token,window.gapi&&window.gapi.load?a().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),i()}):(e=function(){window.gapi&&window.gapi.load?a().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),i()}):setTimeout(e,100)})())}document.addEventListener("DOMContentLoaded",u),window.TrackerAuth={getToken:function(){return o()||null},clearTokens:function(){i(),r.accessToken=null,document.dispatchEvent(new CustomEvent("tracker:auth:signout"))},isAuthenticated:function(){var e=o();return!(!e||!c(e))},refreshToken:l,initAuthUI:u,onSignInClick:d,withValidToken:function(a){return new Promise(function(t,n){var e=o();e&&c(e)?(r.accessToken=e.access_token,gapi.client.setToken({access_token:e.access_token}),a().then(t).catch(n)):e&&e.refresh_token?l().then(function(e){gapi.client.setToken({access_token:e.access_token}),a().then(t).catch(n)}).catch(function(e){i(),n(new Error("Token refresh failed, please sign in again"))}):n(new Error("No valid token available, please sign in"))})}}})(),(()=>{var l=window.CONFIG&&window.CONFIG.SHEET_ID||"",m=["Date","Number","Text","Dropdown"],g={},t=null,v=null,w=null;let d="A";function u(e,t,n){if(null==e||""===e)return!1;switch(t){case"Date":return!isNaN(Date.parse(e));case"Number":return!isNaN(parseFloat(e))&&isFinite(e);case"Text":return"string"==typeof e||"number"==typeof e;case"Dropdown":return!(!n||!n.includes(e));default:return!1}}function e(){return t?Promise.resolve(t):window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.get({spreadsheetId:l,fields:"sheets(properties(sheetId,title),tables(tableId,name,range,columnProperties(columnIndex,columnName,columnType,dataValidationRule(condition(type,values(userEnteredValue))))))"})}).then(function(e){e=(w=e)&&e.result&&e.result.sheets||[];return t=e.map(function(e){return{sheetId:e.properties.sheetId,title:e.properties.title}})})}function n(){var f;return v?(f=v.sheetId,g[f]?Promise.resolve(g[f]):e().then(function(){for(var e=w,t=e&&e.result&&e.result.sheets||[],n=null,a=0;a<t.length;a++)if(t[a]&&t[a].properties&&t[a].properties.sheetId===f){n=t[a];break}if(!n)throw new Error("Sheet not found: "+f);var e=n.properties.sheetId,r=n.tables||[];if(0===r.length)throw new Error("No tables found in sheet: "+v.title);var o=r[0].columnProperties||[];if(0===o.length)throw new Error("No column properties found in table");if("Date"!==o[0].columnName)throw new Error('First column must be "Date"');for(var s={},i=[],c=0;c<o.length;c++){var l=o[c],d=l.columnName,u=l.columnType,h=(i.push(d),"Text"),p=null;u&&("DATE"===(u=String(u).toUpperCase())||"DATE_TIME"===u||"TIME_DATE"===u?h="Date":"DOUBLE"===u||"NUMBER"===u||"PERCENT"===u||"CURRENCY"===u||"SCIENTIFIC"===u?h="Number":"TEXT"===u?h="Text":"DROPDOWN"===u&&(h="Dropdown",l.dataValidationRule)&&l.dataValidationRule.condition&&"ONE_OF_LIST"===l.dataValidationRule.condition.type&&l.dataValidationRule.condition.values&&(p=l.dataValidationRule.condition.values.map(function(e){return e.userEnteredValue}))),s[d]={index:l.columnIndex,type:h,supported:m.includes(h),options:p}}r={columns:s,headers:i,dateColumn:"Date",sheetId:e};return g[f]=r})):Promise.reject(new Error("No tab selected"))}window.TrackerSheets={readLastEntry:function(){return v?n().then(function(s){var e=v.title+"!2:2";return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.get({spreadsheetId:l,range:e,majorDimension:"ROWS"})}).then(function(e){var t=e&&e.result&&e.result.values&&e.result.values[0]||null;if(!t||0===t.length||!t[0])return{date:null,data:{}};var n,a={date:t[0],data:{}};for(n in s.columns){var r=s.columns[n],o=t[r.index];void 0!==o&&""!==o&&("Number"===r.type?a.data[n]=parseFloat(o):(r.type,a.data[n]=o))}return a})}):Promise.reject(new Error("No tab selected"))},appendEntry:function(c){return v?n().then(function(e){for(var t in c)if("Date"!==t){var n=e.columns[t];if(!n)throw new Error("Unknown column: "+t);if(!n.supported)throw new Error("Unsupported column type: "+t+" ("+n.type+")");if(!u(c[t],n.type,n.options))throw new Error("Invalid data for column "+t+": expected "+n.type)}var a=new Array(e.headers.length);a[0]=(new Date).toISOString().split("T")[0];for(var r=1;r<e.headers.length;r++){var o=e.headers[r],o=c[o]||"";a[r]=o}var s={values:[a]},i=(e=>{for(var t=e+1,n="";0<t;)var a=(t-1)%26,n=String.fromCharCode(d.charCodeAt(0)+a)+n,t=Math.floor((t-a)/26);return n})(e.headers.length-1);if(e.sheetId)return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:l,resource:{requests:[{insertDimension:{range:{sheetId:e.sheetId,dimension:"ROWS",startIndex:1,endIndex:2},inheritFromBefore:!1}}]}})}).then(function(){return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.update({spreadsheetId:l,range:v.title+"!A2:"+i+"2",valueInputOption:"USER_ENTERED",resource:s})})}).then(function(){return{ok:!0,date:a[0],data:c}});throw new Error("Sheet ID not available in column metadata.")}):Promise.reject(new Error("No tab selected"))},getColumnMetadata:n,getTabId:function(){return v?Promise.resolve(v.sheetId):Promise.reject(new Error("No tab selected"))},validateData:u,getAvailableTabs:e,setSelectedTab:function(t){return e().then(function(e){e=e.find(function(e){return e.sheetId===t});if(!e)throw new Error("Tab not found: "+t);v=e,g[t]=null})},getSelectedTab:function(){return v},clearCache:function(){g={},w=v=t=null}}})(),(()=>{var d={},u={date:null,data:{}},h=null,p={};function e(e){return document.getElementById(e)}function f(e,t){d.status.textContent=e,d.status.className="alert "+("error"===t?"alert-danger":"alert-success"),d.status.style.display="block",setTimeout(function(){d.status.style.display="none"},3e3)}function n(e){h=e,d.formContainer.innerHTML="";for(var t=e.headers,n=e.columns,a=1;a<t.length;a++){var r=t[a],o=n[r];o&&o.supported&&(o=((e,t,n)=>{var a,r=document.createElement("div"),o=(r.className="form-group",document.createElement("label"));if(o.textContent=e,o.setAttribute("for","input_"+e),o.style.display="block",o.style.marginBottom="5px",o.style.fontWeight="500","Dropdown"===t.type){(a=document.createElement("select")).id="input_"+e,a.name=e,a.className="form-control",a.style.textAlign="center";var s=document.createElement("option");if(s.value="",s.textContent="Select "+e.toLowerCase(),a.appendChild(s),t.options&&0<t.options.length)for(var i=0;i<t.options.length;i++){var c=document.createElement("option");c.value=t.options[i],c.textContent=t.options[i],n===t.options[i]&&(c.selected=!0),a.appendChild(c)}}else switch((a=document.createElement("input")).id="input_"+e,a.name=e,a.className="form-control",a.style.textAlign="center",t.type){case"Date":a.type="date",a.value=n||"";break;case"Number":a.type="number",a.step="0.1",a.placeholder="e.g. 175.2",a.value=n||"";break;case"Text":a.type="text",a.placeholder="Enter "+e.toLowerCase(),a.value=n||"";break;default:a.type="text",a.value=n||""}return r.appendChild(o),r.appendChild(a),p[e]=a,r})(r,o,u.data[r]||""),d.formContainer.appendChild(o))}}function m(){u.date?d.lastDate.textContent="Last updated: "+new Date(u.date).toLocaleString():d.lastDate.textContent="No previous entries"}function r(){var e=parseInt(d.tabSelector.value);e&&(d.formPanel&&(d.formPanel.style.display="block"),d.saveFeedbackPanel&&(d.saveFeedbackPanel.style.display="none"),d.saveFeedback&&(d.saveFeedback.innerHTML=""),d.formContainer.innerHTML="",u={date:null,data:{}},h=null,p={},window.TrackerSheets.setSelectedTab(e).then(function(){return Promise.all([window.TrackerSheets.getColumnMetadata(),window.TrackerSheets.readLastEntry()])}).then(function(e){var t=e[0];u=e[1],n(t),m(),f("Switched to tab: "+window.TrackerSheets.getSelectedTab().title,"success")}).catch(function(e){console.error("Failed to switch tab:",e),f("Failed to switch tab: "+e.message,"error"),e&&e.message&&(-1!==e.message.indexOf("token")||-1!==e.message.indexOf("sign in"))&&(d.auth.style.display="block",d.main.style.display="none")}))}function t(){d.auth.style.display="none",d.main.style.display="block",window.TrackerSheets.getAvailableTabs().then(function(e){d.tabSelector.innerHTML="";var t=document.createElement("option");t.value="",t.textContent="Select a tab...",d.tabSelector.appendChild(t);for(var n=0;n<e.length;n++){var a=document.createElement("option");a.value=e[n].sheetId,a.textContent=e[n].title,d.tabSelector.appendChild(a)}0<e.length&&(d.tabSelector.value=e[0].sheetId,r())}).catch(function(e){console.error("Failed to load tabs:",e),f("Failed to load tabs: "+e.message,"error"),(e.message.includes("token")||e.message.includes("sign in"))&&(d.auth.style.display="block",d.main.style.display="none")})}function a(e){console.error("Authentication error:",e.detail),f("Authentication failed: "+e.detail.message,"error"),d.auth.style.display="block",d.main.style.display="none"}function o(){d.auth.style.display="block",d.main.style.display="none",d.formContainer.innerHTML="",d.tabSelector&&(d.tabSelector.innerHTML='<option value="">Loading tabs...</option>'),u={date:null,data:{}},h=null,p={}}function s(){if(h){var e,c,l={},t=!1;for(e in p){var n=p[e].value.trim();if(""!==n){var a=h.columns[e];if(!window.TrackerSheets.validateData(n,a.type,a.options))return void f("Invalid data for "+e+" (expected "+a.type+")","error");"Number"===a.type?l[e]=parseFloat(n):l[e]=n,t=!0}}t?(c={date:u.date,data:JSON.parse(JSON.stringify(u.data||{}))},window.TrackerSheets.appendEntry(l).then(function(e){var t=((e,t,n)=>{var a=[];if(n&&n.headers&&n.columns)for(var r=1;r<n.headers.length;r++){var o,s,i,c,l,d,u=n.headers[r],h=n.columns[u]||{type:"Text"},p=e&&e.data&&void 0!==e.data[u]?e.data[u]:"",f=t&&void 0!==t[u]?t[u]:"";"Number"===(h.type||"Text")?(h=Number(p),c=Number(f),o=isFinite(h),s=isFinite(c),i=o&&s?c!==h:String(f)!==String(p),l="0",d="neutral",o&&s?(l=(0<(c=c-h)?"+":c<0?"-":"")+Math.abs(c).toLocaleString(void 0,{maximumFractionDigits:2}),d=0<c?"increase":c<0?"decrease":"neutral"):i&&(l=(p||"—")+" → "+(f||"—")),a.push({fieldName:u,previous:o?p:p||"—",current:s?f:f||"—",changeText:l,changed:i,changeClass:d})):(h=String(f)!==String(p),a.push({fieldName:u,previous:p||"—",current:f||"—",changeText:h?(p||"—")+" → "+(f||"—"):"No change",changed:h,changeClass:h?"changed":"neutral"}))}return a})(c,l,h);if(d.saveFeedback)if(t&&0!==t.length){for(var n=!1,a=0;a<t.length;a++)if(t[a].changed){n=!0;break}if(n){for(var r,o="",s=0;s<t.length;s++){var i=t[s];o+="\n<tr><td>"+i.fieldName+"</td><td>"+i.previous+"</td><td>"+i.current+'</td><td><span style="color:'+("increase"===(r=i.changeClass)?"#2e7d32":"decrease"===r?"#c62828":"changed"===r?"#000000":"#6c757d")+';">'+i.changeText+"</span></td></tr>"}d.saveFeedback.innerHTML='<table class="table table-sm table-striped"><thead><tr><th>Field</th><th>Previous</th><th>Current</th><th>Change</th></tr></thead><tbody>'+o+"</tbody></table>"}else d.saveFeedback.innerHTML='<div class="alert alert-info">No changes</div>'}else d.saveFeedback.innerHTML='<div class="alert alert-info">No changes</div>';d.formPanel&&(d.formPanel.style.display="none"),d.saveFeedbackPanel&&(d.saveFeedbackPanel.style.display="block"),u={date:e.date,data:l},m(),f("Saved successfully!","success")}).catch(function(e){console.error("Save failed:",e),f("Save failed: "+e.message,"error")})):f("Please enter at least one value","error")}else f("Form not ready","error")}function i(){var t;h?(t=window.CONFIG&&window.CONFIG.SHEET_ID)?window.TrackerSheets.getTabId().then(function(e){window.open("https://docs.google.com/spreadsheets/d/"+t+"/edit#gid="+e,"_blank")}).catch(function(e){console.error("Failed to get tab ID:",e),window.open("https://docs.google.com/spreadsheets/d/"+t+"/edit","_blank"),f("Opened Google Sheets (tab ID not available)","success")}):f("Sheet ID not configured","error"):f("Sheet data not loaded","error")}document.addEventListener("DOMContentLoaded",function(){if(d.auth=e("authSection"),d.main=e("mainSection"),d.formPanel=e("formPanel"),d.formContainer=e("formContainer"),d.lastDate=e("lastDate"),d.save=e("saveBtn"),d.openSheets=e("openSheetsBtn"),d.status=e("statusMessage"),d.tabSelector=e("tabSelector"),d.saveFeedbackPanel=e("saveFeedbackPanel"),d.saveFeedback=e("saveFeedback"),!d.auth)throw new Error("Missing required element: #authSection");if(!d.main)throw new Error("Missing required element: #mainSection");if(!d.formContainer)throw new Error("Missing required element: #formContainer");if(!d.formPanel)throw new Error("Missing required element: #formPanel");if(!d.save)throw new Error("Missing required element: #saveBtn");if(!d.status)throw new Error("Missing required element: #statusMessage");d.save.addEventListener("click",s),d.openSheets&&d.openSheets.addEventListener("click",i),d.tabSelector&&d.tabSelector.addEventListener("change",r),document.addEventListener("tracker:auth:ready",t),document.addEventListener("tracker:auth:error",a),document.addEventListener("tracker:auth:signout",o)})})();
window.CONFIG={CLIENT_ID:"209191307792-57cp00mia6fgfc7dj0ohbbgqqtfu45q4.apps.googleusercontent.com",SHEET_ID:"1t73pb_DWXW5hBySNJeIjrkve72pVTae1iaYCj-MMBog",TRACKER_SHEET:"Sheet3",SCOPES:"https://www.googleapis.com/auth/spreadsheets"},(()=>{var t="tracker_oauth_tokens",n=3e5,r={accessToken:null,gapiLoaded:!1,tokenClient:null};function o(){return new Promise(function(e,t){r.gapiLoaded&&gapi.client?e():window.gapi&&gapi.load?gapi.load("client",function(){gapi.client.init({discoveryDocs:["https://sheets.googleapis.com/$discovery/rest?version=v4"]}).then(function(){r.gapiLoaded=!0,e()}).catch(t)}):t(new Error("gapi not loaded"))})}function a(){try{var e=localStorage.getItem(t);return e?JSON.parse(e):null}catch(e){return console.error("Error reading stored tokens:",e),null}}function i(e){try{localStorage.setItem(t,JSON.stringify(e))}catch(e){console.error("Error storing tokens:",e)}}function s(){try{localStorage.removeItem(t)}catch(e){console.error("Error clearing tokens:",e)}}function c(e){return e&&e.access_token&&e.expires_at&&Date.now()<e.expires_at-n}function l(){return new Promise(function(t,n){var e,o=a();o&&o.refresh_token?((e=new URLSearchParams).append("client_id",window.CONFIG.CLIENT_ID),e.append("refresh_token",o.refresh_token),e.append("grant_type","refresh_token"),fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}).then(function(e){return e.json()}).then(function(e){e.error?n(new Error("Token refresh failed: "+e.error)):(i(e={access_token:e.access_token,refresh_token:o.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:o.scope,token_type:o.token_type||"Bearer"}),r.accessToken=e.access_token,t(e))}).catch(n)):n(new Error("No refresh token available"))})}function e(){return new Promise(function(n,o){try{var e=(()=>{if(!r.tokenClient){if(!window.google||!google.accounts||!google.accounts.oauth2)throw new Error("Google Identity Services not available");r.tokenClient=google.accounts.oauth2.initTokenClient({client_id:window.CONFIG&&window.CONFIG.CLIENT_ID,scope:window.CONFIG&&window.CONFIG.SCOPES,callback:function(){}})}return r.tokenClient})();e.callback=function(e){var t;e&&e.access_token?(i(t={access_token:e.access_token,refresh_token:e.refresh_token,expires_at:Date.now()+1e3*e.expires_in,scope:e.scope,token_type:e.token_type||"Bearer"}),r.accessToken=e.access_token,n(t)):o(new Error("No access token"))},e.requestAccessToken({prompt:""})}catch(e){o(e)}})}function d(){e().then(function(e){return o().then(function(){return e})}).then(function(e){gapi.client.setToken({access_token:e.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:e.access_token,tokenData:e}}))}).catch(function(e){console.error("Sign-in error:",e),s(),document.dispatchEvent(new CustomEvent("tracker:auth:error",{detail:e}))})}function u(){var e,t=document.getElementById("googleSignInBtn"),n=(t&&t.addEventListener("click",d),a());n&&c(n)&&(r.accessToken=n.access_token,window.gapi&&window.gapi.load?o().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),s()}):(e=function(){window.gapi&&window.gapi.load?o().then(function(){gapi.client.setToken({access_token:n.access_token}),document.dispatchEvent(new CustomEvent("tracker:auth:ready",{detail:{token:n.access_token,tokenData:n}}))}).catch(function(e){console.error("Error loading with stored token:",e),s()}):setTimeout(e,100)})())}document.addEventListener("DOMContentLoaded",u),window.TrackerAuth={getToken:function(){return a()||null},clearTokens:function(){s(),r.accessToken=null,document.dispatchEvent(new CustomEvent("tracker:auth:signout"))},isAuthenticated:function(){var e=a();return!(!e||!c(e))},refreshToken:l,initAuthUI:u,onSignInClick:d,withValidToken:function(o){return new Promise(function(t,n){var e=a();e&&c(e)?(r.accessToken=e.access_token,gapi.client.setToken({access_token:e.access_token}),o().then(t).catch(n)):e&&e.refresh_token?l().then(function(e){gapi.client.setToken({access_token:e.access_token}),o().then(t).catch(n)}).catch(function(e){s(),n(new Error("Token refresh failed, please sign in again"))}):n(new Error("No valid token available, please sign in"))})}}})(),(()=>{var l=window.CONFIG&&window.CONFIG.SHEET_ID||"",f=window.CONFIG&&window.CONFIG.TRACKER_SHEET||"Sheet3",m=["Date","Number","Text","Dropdown"],w=null;let d="A";function u(e,t,n){if(null==e||""===e)return!1;switch(t){case"Date":return!isNaN(Date.parse(e));case"Number":return!isNaN(parseFloat(e))&&isFinite(e);case"Text":return"string"==typeof e||"number"==typeof e;case"Dropdown":return!(!n||!n.includes(e));default:return!1}}function e(){return w?Promise.resolve(w):window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.get({spreadsheetId:l,fields:"sheets(properties(sheetId,title),tables(tableId,name,range,columnProperties(columnIndex,columnName,columnType,dataValidationRule(condition(type,values(userEnteredValue))))))"})}).then(function(e){for(var t=e&&e.result&&e.result.sheets||[],n=null,o=0;o<t.length;o++)if(t[o]&&t[o].properties&&t[o].properties.title===f){n=t[o];break}if(!n)throw new Error("Sheet not found: "+f);var e=n.properties.sheetId,r=n.tables||[];if(0===r.length)throw new Error("No tables found in sheet: "+f);var a=r[0].columnProperties||[];if(0===a.length)throw new Error("No column properties found in table");if("Date"!==a[0].columnName)throw new Error('First column must be "Date"');for(var i={},s=[],c=0;c<a.length;c++){var l=a[c],d=l.columnName,u=l.columnType,h=(s.push(d),"Text"),p=null;u&&("DATE"===(u=String(u).toUpperCase())||"DATE_TIME"===u||"TIME_DATE"===u?h="Date":"NUMBER"===u||"PERCENT"===u||"CURRENCY"===u||"SCIENTIFIC"===u?h="Number":"TEXT"===u?h="Text":"DROPDOWN"===u&&(h="Dropdown",l.dataValidationRule)&&l.dataValidationRule.condition&&"ONE_OF_LIST"===l.dataValidationRule.condition.type&&l.dataValidationRule.condition.values&&(p=l.dataValidationRule.condition.values.map(function(e){return e.userEnteredValue}))),i[d]={index:l.columnIndex,type:h,supported:m.includes(h),options:p}}return w={columns:i,headers:s,dateColumn:"Date",sheetId:e}})}window.TrackerSheets={readLastEntry:function(){return e().then(function(i){var e=f+"!2:2";return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.get({spreadsheetId:l,range:e,majorDimension:"ROWS"})}).then(function(e){var t=e&&e.result&&e.result.values&&e.result.values[0]||null;if(!t||0===t.length||!t[0])return{date:null,data:{}};var n,o={date:t[0],data:{}};for(n in i.columns){var r=i.columns[n],a=t[r.index];void 0!==a&&""!==a&&("Number"===r.type?o.data[n]=parseFloat(a):(r.type,o.data[n]=a))}return o})})},appendEntry:function(c){return e().then(function(e){for(var t in c)if("Date"!==t){var n=e.columns[t];if(!n)throw new Error("Unknown column: "+t);if(!n.supported)throw new Error("Unsupported column type: "+t+" ("+n.type+")");if(!u(c[t],n.type,n.options))throw new Error("Invalid data for column "+t+": expected "+n.type)}var o=new Array(e.headers.length);o[0]=(new Date).toISOString().split("T")[0];for(var r=1;r<e.headers.length;r++){var a=e.headers[r],a=c[a]||"";o[r]=a}var i={values:[o]},s=(e=>{for(var t=e+1,n="";0<t;)var o=(t-1)%26,n=String.fromCharCode(d.charCodeAt(0)+o)+n,t=Math.floor((t-o)/26);return n})(e.headers.length-1);if(e.sheetId)return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.batchUpdate({spreadsheetId:l,resource:{requests:[{insertDimension:{range:{sheetId:e.sheetId,dimension:"ROWS",startIndex:1,endIndex:2},inheritFromBefore:!1}}]}})}).then(function(){return window.TrackerAuth.withValidToken(function(){return gapi.client.sheets.spreadsheets.values.update({spreadsheetId:l,range:f+"!A2:"+s+"2",valueInputOption:"USER_ENTERED",resource:i})})}).then(function(){return{ok:!0,date:o[0],data:c}});throw new Error("Sheet ID not available in column metadata.")})},getColumnMetadata:e,getTabId:function(){return e().then(function(e){if(e.sheetId)return e.sheetId;throw new Error("Tab ID not available for sheet: "+f)})},validateData:u,clearCache:function(){w=null}}})(),(()=>{var i={},s={date:null,data:{}},c=null,l={};function e(e){return document.getElementById(e)}function a(e,t){i.status.textContent=e,i.status.className="alert "+("error"===t?"alert-danger":"alert-success"),i.status.style.display="block",setTimeout(function(){i.status.style.display="none"},3e3)}function n(e){c=e,i.formContainer.innerHTML="";for(var t=e.headers,n=e.columns,o=1;o<t.length;o++){var r=t[o],a=n[r];a&&a.supported&&(a=((e,t,n)=>{var o,r=document.createElement("div"),a=(r.className="form-group",document.createElement("label"));if(a.textContent=e,a.setAttribute("for","input_"+e),a.style.display="block",a.style.marginBottom="5px",a.style.fontWeight="500","Dropdown"===t.type){(o=document.createElement("select")).id="input_"+e,o.name=e,o.className="form-control",o.style.textAlign="center";var i=document.createElement("option");if(i.value="",i.textContent="Select "+e.toLowerCase(),o.appendChild(i),t.options&&0<t.options.length)for(var s=0;s<t.options.length;s++){var c=document.createElement("option");c.value=t.options[s],c.textContent=t.options[s],n===t.options[s]&&(c.selected=!0),o.appendChild(c)}}else switch((o=document.createElement("input")).id="input_"+e,o.name=e,o.className="form-control",o.style.textAlign="center",t.type){case"Date":o.type="date",o.value=n||"";break;case"Number":o.type="number",o.step="0.1",o.placeholder="e.g. 175.2",o.value=n||"";break;case"Text":o.type="text",o.placeholder="Enter "+e.toLowerCase(),o.value=n||"";break;default:o.type="text",o.value=n||""}return r.appendChild(a),r.appendChild(o),l[e]=o,r})(r,a,s.data[r]||""),i.formContainer.appendChild(a))}}function d(){s.date?i.lastDate.textContent="Last updated: "+new Date(s.date).toLocaleString():i.lastDate.textContent="No previous entries"}function t(){i.auth.style.display="none",i.main.style.display="block",Promise.all([window.TrackerSheets.getColumnMetadata(),window.TrackerSheets.readLastEntry()]).then(function(e){var t=e[0];s=e[1],n(t),d()}).catch(function(e){console.error("Failed to load data:",e),a("Failed to load data: "+e.message,"error"),(e.message.includes("token")||e.message.includes("sign in"))&&(i.auth.style.display="block",i.main.style.display="none")})}function o(e){console.error("Authentication error:",e.detail),a("Authentication failed: "+e.detail.message,"error"),i.auth.style.display="block",i.main.style.display="none"}function r(){i.auth.style.display="block",i.main.style.display="none",i.formContainer.innerHTML="",s={date:null,data:{}},c=null,l={}}function u(){if(c){var e,n={},t=!1;for(e in l){var o=l[e].value.trim();if(""!==o){var r=c.columns[e];if(!window.TrackerSheets.validateData(o,r.type,r.options))return void a("Invalid data for "+e+" (expected "+r.type+")","error");"Number"===r.type?n[e]=parseFloat(o):n[e]=o,t=!0}}t?window.TrackerSheets.appendEntry(n).then(function(e){for(var t in s={date:e.date,data:n},d(),a("Saved successfully!","success"),l)l[t].value=""}).catch(function(e){console.error("Save failed:",e),a("Save failed: "+e.message,"error")}):a("Please enter at least one value","error")}else a("Form not ready","error")}function h(){var t;c?(t=window.CONFIG&&window.CONFIG.SHEET_ID)?window.TrackerSheets.getTabId().then(function(e){window.open("https://docs.google.com/spreadsheets/d/"+t+"/edit#gid="+e,"_blank")}).catch(function(e){console.error("Failed to get tab ID:",e),window.open("https://docs.google.com/spreadsheets/d/"+t+"/edit","_blank"),a("Opened Google Sheets (tab ID not available)","success")}):a("Sheet ID not configured","error"):a("Sheet data not loaded","error")}document.addEventListener("DOMContentLoaded",function(){if(i.auth=e("authSection"),i.main=e("mainSection"),i.formContainer=e("formContainer"),i.lastDate=e("lastDate"),i.save=e("saveBtn"),i.openSheets=e("openSheetsBtn"),i.status=e("statusMessage"),!i.auth)throw new Error("Missing required element: #authSection");if(!i.main)throw new Error("Missing required element: #mainSection");if(!i.formContainer)throw new Error("Missing required element: #formContainer");if(!i.save)throw new Error("Missing required element: #saveBtn");if(!i.status)throw new Error("Missing required element: #statusMessage");i.save.addEventListener("click",u),i.openSheets&&i.openSheets.addEventListener("click",h),document.addEventListener("tracker:auth:ready",t),document.addEventListener("tracker:auth:error",o),document.addEventListener("tracker:auth:signout",r)})})();